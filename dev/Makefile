#
# Copyright (c) 2016 Carnegie Mellon University.
# Copyright (c) 2011 The LevelDB Authors.
# ---------------------------------------
# All rights reserved.
#
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file. See the AUTHORS file for names of contributors.

#-----------------------------------------------
# Uncomment exactly one of the lines labeled (A), (B), and (C) below
# to switch between compilation modes.

# (A) Production use (optimized mode)
# OPT ?= -O2 -DNDEBUG -DVERBOSE=1
# (B) Debug mode, w/ full line-level debugging symbols
OPT ?= -g2 -DVERBOSE=10
# (C) Profiling mode: opt, but w/debugging symbols
# OPT ?= -O2 -g2 -DNDEBUG -DVERBOSE=1
#-----------------------------------------------

# detect what platform we're building on
$(shell CC="$(CC)" CXX="$(CXX)" TARGET_OS="$(TARGET_OS)" \
    ./dev/build_detect_platform build_config.mk ./)
# this file is generated by the previous line to set build flags and sources
include build_config.mk

TESTS = \
	src/libdeltafs/mds_api_test \
	src/libdeltafs/mds_srv_test

BINS = \
	src/server/deltafs_server \
	src/cmds/deltafs_shell

CFLAGS += -I./external/pdlfs-common/include -I./include $(PLATFORM_CCFLAGS) $(OPT)
CXXFLAGS += -I./external/pdlfs-common/include -I./include $(PLATFORM_CXXFLAGS) $(OPT)

LDFLAGS += $(PLATFORM_LDFLAGS)
LIBS += $(PLATFORM_LIBS)

OUTDIR=build

STATIC_OUTDIR=out-static

TEST_PROGRAMS := $(addprefix $(STATIC_OUTDIR)/, $(notdir $(TESTS)))
BIN_PROGRAMS := $(addprefix $(STATIC_OUTDIR)/, $(notdir $(BINS)))

TESTUTIL := $(STATIC_OUTDIR)/external/pdlfs-common/src/testutil.o
TESTHARNESS := $(STATIC_OUTDIR)/external/pdlfs-common/src/testharness.o $(TESTUTIL)

STATIC_PDLFS_COMMON_LIBOBJECTS := $(addprefix $(STATIC_OUTDIR)/, $(LIBPDLFS_COMMON_SOURCES:.cc=.o))
STATIC_LIBOBJECTS := $(addprefix $(STATIC_OUTDIR)/, $(LIBDELTAFS_SOURCES:.cc=.o))

STATIC_TESTOBJS := $(addprefix $(STATIC_OUTDIR)/, $(addsuffix .o, $(TESTS)))
STATIC_BINOBJS := $(addprefix $(STATIC_OUTDIR)/, $(addsuffix .o, $(BINS)))
STATIC_ALLOBJS := $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS) \
	$(STATIC_TESTOBJS) $(STATIC_BINOBJS) \
	$(TESTHARNESS)

SHARED_OUTDIR=out-shared

SHARED_PDLFS_COMMON_LIBOBJECTS := $(addprefix $(SHARED_OUTDIR)/, $(LIBPDLFS_COMMON_SOURCES:.cc=.o))
SHARED_LIBOBJECTS := $(addprefix $(SHARED_OUTDIR)/, $(LIBDELTAFS_SOURCES:.cc=.o))

SHARED_ALLOBJS := $(SHARED_LIBOBJECTS) $(SHARED_PDLFS_COMMON_LIBOBJECTS)

ALL = \
	$(STATIC_OUTDIR)/libdeltafs-common-static.a \
	$(SHARED_OUTDIR)/libdeltafs-common.$(PLATFORM_SHARED_EXT) \
	$(STATIC_OUTDIR)/libdeltafs-static.a \
	$(SHARED_OUTDIR)/libdeltafs.$(PLATFORM_SHARED_EXT) \
	$(BIN_PROGRAMS)

default: all

all: $(ALL)
	mkdir -p $(OUTDIR)
	cd $(OUTDIR) && ln -fs ../$(STATIC_OUTDIR)/*.a .
	cd $(OUTDIR) && ln -fs ../$(SHARED_OUTDIR)/*.$(PLATFORM_SHARED_EXT) .
	cd $(OUTDIR) && ln -fs ../$(STATIC_OUTDIR)/deltafs_* .

tests: $(TEST_PROGRAMS)

check: tests
	for t in $(notdir $(TESTS)); do echo "***** Running $$t"; $(STATIC_OUTDIR)/$$t || exit 1; done

clean:
	-rm -rf $(OUTDIR) $(STATIC_OUTDIR) $(SHARED_OUTDIR)
	-rm -f build_config.mk

$(STATIC_OUTDIR):
	mkdir -p $@

$(STATIC_OUTDIR)/external/pdlfs-common/src: | $(STATIC_OUTDIR)
	mkdir -p $@

$(STATIC_OUTDIR)/external/pdlfs-common/src/leveldb: | $(STATIC_OUTDIR)
	mkdir -p $@

$(STATIC_OUTDIR)/external/pdlfs-common/src/leveldb/db: | $(STATIC_OUTDIR)
	mkdir -p $@

$(STATIC_OUTDIR)/external/pdlfs-common/src/rados: | $(STATIC_OUTDIR)
	mkdir -p $@

$(STATIC_OUTDIR)/src/libdeltafs: | $(STATIC_OUTDIR)
	mkdir -p $@

$(STATIC_OUTDIR)/src/cmds: | $(STATIC_OUTDIR)
	mkdir -p $@

$(STATIC_OUTDIR)/src/server: | $(STATIC_OUTDIR)
	mkdir -p $@

.PHONY: STATIC_OBJDIRS
STATIC_OBJDIRS: \
	$(STATIC_OUTDIR)/external/pdlfs-common/src \
	$(STATIC_OUTDIR)/external/pdlfs-common/src/leveldb \
	$(STATIC_OUTDIR)/external/pdlfs-common/src/leveldb/db \
	$(STATIC_OUTDIR)/external/pdlfs-common/src/rados \
	$(STATIC_OUTDIR)/src/libdeltafs \
	$(STATIC_OUTDIR)/src/cmds \
	$(STATIC_OUTDIR)/src/server

$(STATIC_ALLOBJS): | STATIC_OBJDIRS

$(SHARED_OUTDIR):
	mkdir -p $@

$(SHARED_OUTDIR)/external/pdlfs-common/src: | $(SHARED_OUTDIR)
	mkdir -p $@

$(SHARED_OUTDIR)/external/pdlfs-common/src/leveldb: | $(SHARED_OUTDIR)
	mkdir -p $@

$(SHARED_OUTDIR)/external/pdlfs-common/src/leveldb/db: | $(SHARED_OUTDIR)
	mkdir -p $@

$(SHARED_OUTDIR)/external/pdlfs-common/src/rados: | $(SHARED_OUTDIR)
	mkdir -p $@

$(SHARED_OUTDIR)/src/libdeltafs: | $(SHARED_OUTDIR)
	mkdir -p $@

.PHONY: STHARED_OBJDIRS
SHARED_OBJDIRS: \
	$(SHARED_OUTDIR)/external/pdlfs-common/src \
	$(SHARED_OUTDIR)/external/pdlfs-common/src/leveldb \
	$(SHARED_OUTDIR)/external/pdlfs-common/src/leveldb/db \
	$(SHARED_OUTDIR)/external/pdlfs-common/src/rados \
	$(SHARED_OUTDIR)/src/libdeltafs

$(SHARED_ALLOBJS): | SHARED_OBJDIRS

$(STATIC_OUTDIR)/libdeltafs-common-static.a:$(STATIC_PDLFS_COMMON_LIBOBJECTS)
	rm -f $@
	$(AR) -rs $@ $(STATIC_PDLFS_COMMON_LIBOBJECTS)

$(SHARED_OUTDIR)/libdeltafs-common.$(PLATFORM_SHARED_EXT): $(SHARED_PDLFS_COMMON_LIBOBJECTS)
	$(CXX) $(LDFLAGS) $(PLATFORM_SHARED_LDFLAGS)libdeltafs-common.$(PLATFORM_SHARED_EXT) \
		$(SHARED_PDLFS_COMMON_LIBOBJECTS) -o $@ $(LIBS)

$(STATIC_OUTDIR)/libdeltafs-static.a:$(STATIC_LIBOBJECTS)
	rm -f $@
	$(AR) -rs $@ $(STATIC_LIBOBJECTS)

$(SHARED_OUTDIR)/libdeltafs.$(PLATFORM_SHARED_EXT): $(SHARED_LIBOBJECTS)
	$(CXX) $(LDFLAGS) $(PLATFORM_SHARED_LDFLAGS)libdeltafs.$(PLATFORM_SHARED_EXT) \
		$(SHARED_LIBOBJECTS) -o $@ $(LIBS)

$(STATIC_OUTDIR)/deltafs_shell:src/cmds/deltafs_shell.cc $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS)
	$(CXX) $(LDFLAGS) $(CXXFLAGS) src/cmds/deltafs_shell.cc $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS) -o $@ $(LIBS)

$(STATIC_OUTDIR)/deltafs_server:src/server/deltafs_server.cc $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS)
	$(CXX) $(LDFLAGS) $(CXXFLAGS) src/server/deltafs_server.cc $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS) -o $@ $(LIBS)

$(STATIC_OUTDIR)/mds_api_test:src/libdeltafs/mds_api_test.cc $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS) $(TESTHARNESS)
	$(CXX) $(LDFLAGS) $(CXXFLAGS) src/libdeltafs/mds_api_test.cc $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS) $(TESTHARNESS) -o $@ $(LIBS)

$(STATIC_OUTDIR)/mds_srv_test:src/libdeltafs/mds_srv_test.cc $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS) $(TESTHARNESS)
	$(CXX) $(LDFLAGS) $(CXXFLAGS) src/libdeltafs/mds_srv_test.cc $(STATIC_LIBOBJECTS) $(STATIC_PDLFS_COMMON_LIBOBJECTS) $(TESTHARNESS) -o $@ $(LIBS)

$(STATIC_OUTDIR)/%.o: %.cc
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(STATIC_OUTDIR)/%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

$(SHARED_OUTDIR)/%.o: %.cc
	$(CXX) $(CXXFLAGS) $(PLATFORM_SHARED_CFLAGS) -c $< -o $@

$(SHARED_OUTDIR)/%.o: %.c
	$(CC) $(CFLAGS) $(PLATFORM_SHARED_CFLAGS) -c $< -o $@
